<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IRCTC Train Booking</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .irctc-header { background-color: #003366; }
        .login-container { max-width: 400px; margin: 5% auto; }
        .captcha-box { background: #e9ecef; padding: 10px; border-radius: 4px; }
        .irctc-orange { background-color: #FF671F; color: white; }
        .irctc-link { color: #FF671F; text-decoration: none; }
        .main-content { display: none; }
        .train-list { margin-top: 20px; }
        .train-item { border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; border-radius: 4px; }
        .price { color: #4CAF50; font-weight: bold; }
        .suggestions { position: absolute; background: white; border: 1px solid #ccc; border-radius: 4px; width: 100%; z-index: 1000; }
        .hidden { display: none; }
        .search-form { max-width: 800px; margin: 20px auto; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        .date-input { max-width: 200px; }
        .form-group { position: relative; margin-bottom: 1rem; }
        .passenger-form { max-width: 600px; margin: 20px auto; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        .ticket { max-width: 800px; margin: 20px auto; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        .booking-history { max-width: 1000px; margin: 20px auto; }
        .history-item { border: 1px solid #ddd; margin-bottom: 15px; padding: 15px; border-radius: 5px; }
        .status-booked { color: green; }
        .status-cancelled { color: red; }
        .cancel-btn { margin-top: 10px; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg irctc-header">
        <div class="container">
            <a class="navbar-brand text-white" href="#">IRCTC</a>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto" id="navLinks">
                    <li class="nav-item"><a class="nav-link text-white" href="#" onclick="showRegister()">Register</a></li>
                    <li class="nav-item"><a class="nav-link text-white" href="#" onclick="showLogin()">Login</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Login Form -->
    <div class="container" id="loginSection">
        <div class="login-container shadow-sm p-4 bg-white rounded">
            <h4 class="mb-4 text-center">IRCTC Login</h4>
            <form id="loginForm">
                <div class="mb-3">
                    <input type="text" class="form-control" placeholder="User ID" id="loginUserId" required>
                </div>
                <div class="mb-3">
                    <input type="password" class="form-control" placeholder="Password" id="loginPassword" required>
                </div>
                <div class="mb-3">
                    <div class="d-flex align-items-center gap-3">
                        <div class="captcha-box flex-grow-1 text-center fw-bold" id="loginCaptcha"></div>
                        <button type="button" class="btn btn-secondary" onclick="refreshLoginCaptcha()">↻ Refresh</button>
                    </div>
                </div>
                <div class="mb-3">
                    <input type="text" class="form-control" placeholder="Enter Captcha Answer" id="loginCaptchaAnswer" required>
                </div>
                <button type="submit" class="btn irctc-orange w-100 mb-3">LOGIN</button>
                <div class="text-center">
                    <a href="#" class="irctc-link" onclick="showRegister()">New User? Register Here</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Registration Form -->
    <div class="container" id="registerSection" style="display: none;">
        <div class="login-container shadow-sm p-4 bg-white rounded">
            <h4 class="mb-4 text-center">IRCTC Registration</h4>
            <form id="registerForm">
                <div class="mb-3">
                    <input type="text" class="form-control" placeholder="Full Name" id="regName" required>
                </div>
                <div class="mb-3">
                    <input type="email" class="form-control" placeholder="Email" id="regEmail" required>
                </div>
                <div class="mb-3">
                    <input type="text" class="form-control" placeholder="User ID" id="regUserId" required>
                </div>
                <div class="mb-3">
                    <input type="password" class="form-control" placeholder="Password" id="regPassword" required>
                </div>
                <div class="mb-3">
                    <div class="d-flex align-items-center gap-3">
                        <div class="captcha-box flex-grow-1 text-center fw-bold" id="registerCaptcha"></div>
                        <button type="button" class="btn btn-secondary" onclick="refreshRegisterCaptcha()">↻ Refresh</button>
                    </div>
                </div>
                <div class="mb-3">
                    <input type="text" class="form-control" placeholder="Enter Captcha Answer" id="registerCaptchaAnswer" required>
                </div>
                <button type="submit" class="btn irctc-orange w-100 mb-3">REGISTER</button>
                <div class="text-center">
                    <a href="#" class="irctc-link" onclick="showLogin()">Already have account? Login</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="container main-content">
        <div id="dashboard" class="hidden">
            <h2 class="text-center my-4">Welcome to IRCTC Train Booking</h2>
            <div class="d-flex justify-content-center gap-3">
                <button class="btn irctc-orange" onclick="showSearchSection()">Search Trains</button>
                <button class="btn btn-secondary" onclick="viewHistory()">Booking History</button>
                <button class="btn btn-danger" onclick="logout()">Logout</button>
            </div>

            <!-- Active Bookings Section -->
            <div class="booking-history mt-5">
                <h3 class="text-center">Active Bookings</h3>
                <div id="activeBookings"></div>
            </div>
        </div>

        <!-- Search Trains Section -->
        <div id="search-container" class="hidden">
            <div class="search-form">
                <h2 class="text-center mb-4">Search Trains</h2>
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>From</label>
                            <input type="text" class="form-control" id="fromStation" 
                                   oninput="showSuggestions(this.value, 'fromSuggestions')">
                            <div id="fromSuggestions" class="suggestions hidden"></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>To</label>
                            <input type="text" class="form-control" id="toStation" 
                                   oninput="showSuggestions(this.value, 'toSuggestions')">
                            <div id="toSuggestions" class="suggestions hidden"></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>Journey Date</label>
                            <input type="date" class="form-control date-input" id="journeyDate">
                        </div>
                    </div>
                </div>
                <div class="text-center mt-4">
                    <button class="btn irctc-orange" onclick="searchTrains()">Search Trains</button>
                </div>
            </div>
            <div id="trainResults" class="train-list"></div>
        </div>

        <!-- Booking Section -->
        <div id="bookingSection" class="hidden">
            <div class="passenger-form">
                <h2 class="text-center mb-4">Book Your Ticket</h2>
                <div class="mb-3">
                    <label>Select Coach Type</label>
                    <select class="form-control" id="coachType" onchange="updatePrice()">
                        <option value="Sleeper">Sleeper</option>
                        <option value="AC">AC</option>
                        <option value="First Class">First Class</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label>Number of Passengers</label>
                    <input type="number" class="form-control" id="numPassengers" min="1" max="6" onchange="generatePassengerFields()">
                </div>
                <div id="passengerDetails"></div>
                <div class="text-center mt-4">
                    <button class="btn irctc-orange" onclick="confirmBooking()">Confirm Booking</button>
                </div>
            </div>
        </div>

        <!-- Ticket Section -->
        <div id="ticketSection" class="hidden">
            <div class="ticket">
                <h2 class="text-center mb-4">Your Ticket</h2>
                <div id="ticketDetails"></div>
                <div class="text-center mt-4">
                    <button class="btn irctc-orange" onclick="showDashboard()">Back to Dashboard</button>
                    <button class="btn btn-secondary" onclick="viewHistory()">View History</button>
                </div>
            </div>
        </div>

        <!-- History Section -->
        <div id="historySection" class="hidden">
            <div class="booking-history">
                <h2 class="text-center my-4">Booking History</h2>
                <button class="btn btn-secondary mb-3" onclick="showDashboard()">Back to Dashboard</button>
                <div id="historyList"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Hardcoded Data
        const stations = [
            { station_id: 'ST001', station_name: 'Mumbai Central', city: 'Mumbai', state: 'Maharashtra', zone: 'Zone_1' },
            { station_id: 'ST002', station_name: 'Delhi Junction', city: 'Delhi', state: 'Delhi', zone: 'Zone_2' },
            { station_id: 'ST003', station_name: 'Chennai Central', city: 'Chennai', state: 'Tamil Nadu', zone: 'Zone_3' },
            { station_id: 'ST004', station_name: 'Kolkata Howrah', city: 'Kolkata', state: 'West Bengal', zone: 'Zone_4' },
            { station_id: 'ST005', station_name: 'Bangalore City', city: 'Bangalore', state: 'Karnataka', zone: 'Zone_5' },
            { station_id: 'ST006', station_name: 'Hyderabad Deccan', city: 'Hyderabad', state: 'Telangana', zone: 'Zone_6' },
            { station_id: 'ST007', station_name: 'Ahmedabad Junction', city: 'Ahmedabad', state: 'Gujarat', zone: 'Zone_7' },
            { station_id: 'ST008', station_name: 'Pune Junction', city: 'Pune', state: 'Maharashtra', zone: 'Zone_8' },
            { station_id: 'ST009', station_name: 'Jaipur Junction', city: 'Jaipur', state: 'Rajasthan', zone: 'Zone_9' },
            { station_id: 'ST010', station_name: 'Lucknow Junction', city: 'Lucknow', state: 'Uttar Pradesh', zone: 'Zone_10' },
            { station_id: 'ST011', station_name: 'Kanpur Central', city: 'Kanpur', state: 'Uttar Pradesh', zone: 'Zone_11' },
            { station_id: 'ST012', station_name: 'Nagpur Junction', city: 'Nagpur', state: 'Maharashtra', zone: 'Zone_12' },
            { station_id: 'ST013', station_name: 'Patna Junction', city: 'Patna', state: 'Bihar', zone: 'Zone_13' },
            { station_id: 'ST014', station_name: 'Surat Junction', city: 'Surat', state: 'Gujarat', zone: 'Zone_14' },
            { station_id: 'ST015', station_name: 'Bhopal Junction', city: 'Bhopal', state: 'Madhya Pradesh', zone: 'Zone_15' },
            { station_id: 'ST016', station_name: 'Indore Junction', city: 'Indore', state: 'Madhya Pradesh', zone: 'Zone_16' },
            { station_id: 'ST017', station_name: 'Vadodara Junction', city: 'Vadodara', state: 'Gujarat', zone: 'Zone_17' },
            { station_id: 'ST018', station_name: 'Coimbatore Junction', city: 'Coimbatore', state: 'Tamil Nadu', zone: 'Zone_18' },
            { station_id: 'ST019', station_name: 'Kochi Junction', city: 'Kochi', state: 'Kerala', zone: 'Zone_19' },
            { station_id: 'ST020', station_name: 'Visakhapatnam Junction', city: 'Visakhapatnam', state: 'Andhra Pradesh', zone: 'Zone_20' }
        ];

        const trains = [];
        for (let i = 1; i <= 6; i++) {
            for (let j = 0; j < stations.length; j++) {
                for (let k = 0; k < stations.length; k++) {
                    if (j !== k) {
                        trains.push({
                            train_id: `TR${1000 + i + j + k}`,
                            train_name: `Train_${i}_${j}_${k}`,
                            source: stations[j].station_id,
                            destination: stations[k].station_id
                        });
                    }
                }
            }
        }

        const schedules = [];
        const startDate = new Date();
        for (let i = 0; i < 30; i++) {
            const date = new Date(startDate);
            date.setDate(startDate.getDate() + i);
            const dateStr = date.toISOString().split('T')[0];
            trains.forEach(train => {
                schedules.push({
                    date: dateStr,
                    train_id: train.train_id,
                    status: Math.random() > 0.1 ? 'On Time' : 'Cancelled'
                });
            });
        }

        // Authentication System
        let users = JSON.parse(localStorage.getItem('users')) || [];
        let selectedTrain = null;
        let basePrice = 0;

        function initializeUserData() {
            users = users.map(user => ({
                ...user,
                bookings: user.bookings || []
            }));
            localStorage.setItem('users', JSON.stringify(users));
        }

        // Captcha Functions
        function generateCaptcha() {
            const num1 = Math.floor(Math.random() * 10);
            const num2 = Math.floor(Math.random() * 10);
            return { 
                question: `${num1} + ${num2}`, 
                answer: (num1 + num2).toString()
            };
        }

        function refreshLoginCaptcha() {
            const captcha = generateCaptcha();
            document.getElementById('loginCaptcha').textContent = captcha.question;
            localStorage.setItem('loginCaptcha', captcha.answer);
        }

        function refreshRegisterCaptcha() {
            const captcha = generateCaptcha();
            document.getElementById('registerCaptcha').textContent = captcha.question;
            localStorage.setItem('registerCaptcha', captcha.answer);
        }

        // Form Handling
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const userId = document.getElementById('loginUserId').value;
            const password = document.getElementById('loginPassword').value;
            const captchaAnswer = document.getElementById('loginCaptchaAnswer').value;
            const storedCaptcha = localStorage.getItem('loginCaptcha');

            if(captchaAnswer !== storedCaptcha) {
                alert('Invalid Captcha!');
                refreshLoginCaptcha();
                return;
            }

            const user = users.find(u => u.userId === userId && u.password === password);
            if(user) {
                localStorage.setItem('loggedIn', 'true');
                localStorage.setItem('currentUser', JSON.stringify(user));
                showMainContent();
            } else {
                alert('Invalid credentials!');
                refreshLoginCaptcha();
            }
        });

        document.getElementById('registerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const user = {
                name: document.getElementById('regName').value,
                email: document.getElementById('regEmail').value,
                userId: document.getElementById('regUserId').value,
                password: document.getElementById('regPassword').value,
                bookings: []
            };
            const captchaAnswer = document.getElementById('registerCaptchaAnswer').value;
            const storedCaptcha = localStorage.getItem('registerCaptcha');

            if(captchaAnswer !== storedCaptcha) {
                alert('Invalid Captcha!');
                refreshRegisterCaptcha();
                return;
            }

            if(users.some(u => u.userId === user.userId)) {
                alert('User ID already exists!');
                refreshRegisterCaptcha();
                return;
            }

            users.push(user);
            localStorage.setItem('users', JSON.stringify(users));
            alert('Registration successful! Please login.');
            showLogin();
        });

        // Train Search Functions
        function showSuggestions(value, suggestionId) {
            const input = value.toLowerCase();
            const suggestions = stations.filter(station => 
                station.station_name.toLowerCase().includes(input)
            );
            
            const suggestionBox = document.getElementById(suggestionId);
            suggestionBox.innerHTML = '';
            
            suggestions.forEach(station => {
                const div = document.createElement('div');
                div.className = 'p-2 suggestion-item';
                div.textContent = station.station_name;
                div.onclick = () => selectStation(station.station_name, suggestionId);
                suggestionBox.appendChild(div);
            });
            
            suggestionBox.classList.toggle('hidden', !input || suggestions.length === 0);
        }

        function selectStation(station, suggestionId) {
            const inputId = suggestionId === 'fromSuggestions' ? 'fromStation' : 'toStation';
            document.getElementById(inputId).value = station;
            document.getElementById(suggestionId).classList.add('hidden');
        }

        function searchTrains() {
            const fromInput = document.getElementById('fromStation').value;
            const toInput = document.getElementById('toStation').value;
            const date = document.getElementById('journeyDate').value;

            const fromStation = stations.find(s => s.station_name === fromInput);
            const toStation = stations.find(s => s.station_name === toInput);

            if(!fromStation || !toStation) {
                alert('Please select valid stations');
                return;
            }

            if(fromStation.station_id === toStation.station_id) {
                alert('From and To stations cannot be same');
                return;
            }

            if(!date) {
                alert('Please select journey date');
                return;
            }

            const availableTrains = trains.filter(train => 
                train.source === fromStation.station_id && 
                train.destination === toStation.station_id
            );

            const validTrains = availableTrains.filter(train => {
                const schedule = schedules.find(s => 
                    s.train_id === train.train_id && 
                    s.date === date &&
                    s.status !== 'Cancelled'
                );
                return !!schedule;
            });

            if(validTrains.length === 0) {
                alert('No trains available for selected route and date');
                return;
            }

            const trainData = validTrains.map(train => ({
                ...train,
                status: schedules.find(s => s.train_id === train.train_id && s.date === date).status,
                price: calculateFare(fromStation.zone, toStation.zone)
            }));

            displayTrains(trainData);
        }

        function calculateFare(fromZone, toZone) {
            const zoneDiff = Math.abs(parseInt(fromZone.slice(-1)) - parseInt(toZone.slice(-1)));
            return 500 + Math.abs(zoneDiff) * 100;
        }

        function displayTrains(trains) {
            const resultsDiv = document.getElementById('trainResults');
            resultsDiv.innerHTML = '';

            trains.forEach(train => {
                const trainDiv = document.createElement('div');
                trainDiv.className = 'train-item';
                trainDiv.innerHTML = `
                    <h4>${train.train_name} (${train.train_id})</h4>
                    <div class="row">
                        <div class="col-md-3">
                            <div>Source: ${stations.find(s => s.station_id === train.source).station_name}</div>
                            <div>Destination: ${stations.find(s => s.station_id === train.destination).station_name}</div>
                        </div>
                        <div class="col-md-3">
                            <div>Status: ${train.status}</div>
                            <div>Date: ${document.getElementById('journeyDate').value}</div>
                        </div>
                        <div class="col-md-3 price">
                            ₹ ${train.price}
                        </div>
                        <div class="col-md-3">
                            <button class="btn irctc-orange" 
                                onclick="initiateBooking('${train.train_id}', ${train.price})">
                                Book Now
                            </button>
                        </div>
                    </div>
                `;
                resultsDiv.appendChild(trainDiv);
            });
        }

        function initiateBooking(trainId, price) {
            selectedTrain = trains.find(t => t.train_id === trainId);
            basePrice = price;
            document.getElementById('search-container').classList.add('hidden');
            document.getElementById('bookingSection').classList.remove('hidden');
            updatePrice();
        }

        function updatePrice() {
            const coachType = document.getElementById('coachType').value;
            let multiplier = 1;
            switch(coachType) {
                case 'AC': multiplier = 1.5; break;
                case 'First Class': multiplier = 2; break;
            }
            const totalPrice = basePrice * multiplier;
            document.getElementById('totalPrice').textContent = `Total Price: ₹ ${totalPrice}`;
        }

        function generatePassengerFields() {
            const numPassengers = document.getElementById('numPassengers').value;
            const passengerDetailsDiv = document.getElementById('passengerDetails');
            passengerDetailsDiv.innerHTML = '';

            for(let i = 1; i <= numPassengers; i++) {
                const passengerDiv = document.createElement('div');
                passengerDiv.className = 'mb-3';
                passengerDiv.innerHTML = `
                    <h5>Passenger ${i}</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <input type="text" class="form-control" placeholder="Name" required>
                        </div>
                        <div class="col-md-6">
                            <input type="number" class="form-control" placeholder="Age" required>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-6">
                            <select class="form-control" required>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <input type="text" class="form-control" placeholder="Berth Preference" required>
                        </div>
                    </div>
                `;
                passengerDetailsDiv.appendChild(passengerDiv);
            }
        }

        function confirmBooking() {
            const coachType = document.getElementById('coachType').value;
            const numPassengers = document.getElementById('numPassengers').value;
            const passengerDetails = document.querySelectorAll('#passengerDetails input, #passengerDetails select');

            let allFilled = true;
            passengerDetails.forEach(input => {
                if(!input.value) allFilled = false;
            });

            if(!allFilled) {
                alert('Please fill all passenger details');
                return;
            }

            const multiplier = coachType === 'AC' ? 1.5 : coachType === 'First Class' ? 2 : 1;
            const totalPrice = basePrice * multiplier;
            
            const seatNumbers = [];
            const coachPositions = [];
            for (let i = 0; i < numPassengers; i++) {
                seatNumbers.push(Math.floor(Math.random() * 50) + 1);
                coachPositions.push(`Coach ${String.fromCharCode(65 + i)}`);
            }

            const booking = {
                bookingId: 'B' + Date.now(),
                trainId: selectedTrain.train_id,
                date: document.getElementById('journeyDate').value,
                coachType: coachType,
                passengers: Array.from(passengerDetails).map(input => input.value),
                seatNumbers: seatNumbers,
                coachPositions: coachPositions,
                price: totalPrice,
                status: 'booked',
                bookingDate: new Date().toISOString().split('T')[0]
            };

            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            currentUser.bookings.push(booking);
            users = users.map(u => u.userId === currentUser.userId ? currentUser : u);
            localStorage.setItem('users', JSON.stringify(users));
            localStorage.setItem('currentUser', JSON.stringify(currentUser));

            displayTicket(booking);
        }

        function displayTicket(booking) {
            const ticketDetailsDiv = document.getElementById('ticketDetails');
            const train = trains.find(t => t.train_id === booking.trainId);
            
            ticketDetailsDiv.innerHTML = `
                <h4>${train.train_name} (${train.train_id})</h4>
                <div class="row">
                    <div class="col-md-6">
                        <div>Booking ID: ${booking.bookingId}</div>
                        <div>Source: ${stations.find(s => s.station_id === train.source).station_name}</div>
                        <div>Destination: ${stations.find(s => s.station_id === train.destination).station_name}</div>
                    </div>
                    <div class="col-md-6">
                        <div>Journey Date: ${booking.date}</div>
                        <div>Coach Type: ${booking.coachType}</div>
                        <div>Total Price: ₹ ${booking.price}</div>
                        <div>Status: <span class="status-${booking.status}">${booking.status}</span></div>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-md-12">
                        <h5>Passenger Details</h5>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Age</th>
                                    <th>Gender</th>
                                    <th>Berth Preference</th>
                                    <th>Seat Number</th>
                                    <th>Coach Position</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${booking.passengers.map((_, index) => `
                                    <tr>
                                        <td>${booking.passengers[index*4]}</td>
                                        <td>${booking.passengers[index*4+1]}</td>
                                        <td>${booking.passengers[index*4+2]}</td>
                                        <td>${booking.passengers[index*4+3]}</td>
                                        <td>${booking.seatNumbers[index]}</td>
                                        <td>${booking.coachPositions[index]}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            document.getElementById('bookingSection').classList.add('hidden');
            document.getElementById('ticketSection').classList.remove('hidden');
        }

        function viewHistory() {
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('historySection').classList.remove('hidden');
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';

            currentUser.bookings.forEach(booking => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <div class="row">
                        <div class="col-md-8">
                            <h5>${booking.trainId} - ${stations.find(s => s.station_id === trains.find(t => t.train_id === booking.trainId).source).station_name} to 
                            ${stations.find(s => s.station_id === trains.find(t => t.train_id === booking.trainId).destination).station_name}</h5>
                            <div>Booking Date: ${booking.bookingDate}</div>
                            <div>Journey Date: ${booking.date}</div>
                            <div>Status: <span class="status-${booking.status}">${booking.status}</span></div>
                        </div>
                        <div class="col-md-4 text-end">
                            <div>Total Paid: ₹ ${booking.price}</div>
                            ${new Date(booking.date) > new Date() && booking.status === 'booked' ? 
                                `<button class="btn btn-danger cancel-btn" onclick="cancelBooking('${booking.bookingId}')">Cancel Ticket</button>` : ''}
                            <button class="btn irctc-orange" onclick="viewTicket('${booking.bookingId}')">View Details</button>
                        </div>
                    </div>
                `;
                historyList.appendChild(historyItem);
            });
        }

        function cancelBooking(bookingId) {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            const booking = currentUser.bookings.find(b => b.bookingId === bookingId);
            
            if (confirm(`Are you sure you want to cancel booking ${bookingId}?`)) {
                booking.status = 'cancelled';
                users = users.map(u => u.userId === currentUser.userId ? currentUser : u);
                localStorage.setItem('users', JSON.stringify(users));
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                viewHistory();
            }
        }

        function viewTicket(bookingId) {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            const booking = currentUser.bookings.find(b => b.bookingId === bookingId);
            const train = trains.find(t => t.train_id === booking.trainId);
            
            const ticketDetailsDiv = document.getElementById('ticketDetails');
            ticketDetailsDiv.innerHTML = `
                <h4>${train.train_name} (${train.train_id})</h4>
                <div class="row">
                    <div class="col-md-6">
                        <div>Booking ID: ${booking.bookingId}</div>
                        <div>Source: ${stations.find(s => s.station_id === train.source).station_name}</div>
                        <div>Destination: ${stations.find(s => s.station_id === train.destination).station_name}</div>
                    </div>
                    <div class="col-md-6">
                        <div>Journey Date: ${booking.date}</div>
                        <div>Coach Type: ${booking.coachType}</div>
                        <div>Total Price: ₹ ${booking.price}</div>
                        <div>Status: <span class="status-${booking.status}">${booking.status}</span></div>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-md-12">
                        <h5>Passenger Details</h5>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Age</th>
                                    <th>Gender</th>
                                    <th>Berth Preference</th>
                                    <th>Seat Number</th>
                                    <th>Coach Position</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${booking.passengers.map((_, index) => `
                                    <tr>
                                        <td>${booking.passengers[index*4]}</td>
                                        <td>${booking.passengers[index*4+1]}</td>
                                        <td>${booking.passengers[index*4+2]}</td>
                                        <td>${booking.passengers[index*4+3]}</td>
                                        <td>${booking.seatNumbers[index]}</td>
                                        <td>${booking.coachPositions[index]}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            document.getElementById('historySection').classList.add('hidden');
            document.getElementById('ticketSection').classList.remove('hidden');
        }

        // UI Functions
        function showMainContent() {
            document.getElementById('mainContent').style.display = 'block';
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('registerSection').style.display = 'none';
            document.getElementById('navLinks').innerHTML = `
                <li class="nav-item"><a class="nav-link text-white" href="#" onclick="showDashboard()">Dashboard</a></li>
                <li class="nav-item"><a class="nav-link text-white" href="#" onclick="logout()">Logout</a></li>
            `;
            showDashboard();
            initializeDate();
        }

        function showDashboard() {
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('search-container').classList.add('hidden');
            document.getElementById('bookingSection').classList.add('hidden');
            document.getElementById('ticketSection').classList.add('hidden');
            document.getElementById('historySection').classList.add('hidden');
            loadActiveBookings();
        }

        function loadActiveBookings() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            const activeBookingsDiv = document.getElementById('activeBookings');
            activeBookingsDiv.innerHTML = '';

            const activeBookings = currentUser.bookings.filter(booking => 
                booking.status === 'booked' && new Date(booking.date) > new Date()
            );

            if (activeBookings.length === 0) {
                activeBookingsDiv.innerHTML = '<p>No active bookings found.</p>';
                return;
            }

            activeBookings.forEach(booking => {
                const bookingDiv = document.createElement('div');
                bookingDiv.className = 'history-item';
                bookingDiv.innerHTML = `
                    <div class="row">
                        <div class="col-md-8">
                            <h5>${booking.trainId} - ${stations.find(s => s.station_id === trains.find(t => t.train_id === booking.trainId).source).station_name} to 
                            ${stations.find(s => s.station_id === trains.find(t => t.train_id === booking.trainId).destination).station_name}</h5>
                            <div>Booking Date: ${booking.bookingDate}</div>
                            <div>Journey Date: ${booking.date}</div>
                            <div>Status: <span class="status-${booking.status}">${booking.status}</span></div>
                        </div>
                        <div class="col-md-4 text-end">
                            <div>Total Paid: ₹ ${booking.price}</div>
                            <button class="btn btn-danger cancel-btn" onclick="cancelBooking('${booking.bookingId}')">Cancel Ticket</button>
                            <button class="btn irctc-orange" onclick="viewTicket('${booking.bookingId}')">View Details</button>
                        </div>
                    </div>
                `;
                activeBookingsDiv.appendChild(bookingDiv);
            });
        }

        function showSearchSection() {
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('search-container').classList.remove('hidden');
        }

        function showLogin() {
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('registerSection').style.display = 'none';
            refreshLoginCaptcha();
        }

        function showRegister() {
            document.getElementById('registerSection').style.display = 'block';
            document.getElementById('loginSection').style.display = 'none';
            refreshRegisterCaptcha();
        }

        function logout() {
            localStorage.removeItem('loggedIn');
            localStorage.removeItem('currentUser');
            location.reload();
        }

        function initializeDate() {
            const dateInput = document.getElementById('journeyDate');
            const today = new Date().toISOString().split('T')[0];
            const maxDate = new Date(Date.now() + 30 * 86400000).toISOString().split('T')[0];
            dateInput.min = today;
            dateInput.max = maxDate;
            dateInput.value = today;
        }

        // Initial Setup
        document.addEventListener('DOMContentLoaded', function() {
            initializeUserData();
            if(localStorage.getItem('loggedIn')) {
                showMainContent();
            } else {
                refreshLoginCaptcha();
                refreshRegisterCaptcha();
            }
        });
    </script>
</body>
</html>